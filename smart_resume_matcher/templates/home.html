{% extends 'base_modern.html' %}

{% block title %}Home - Smart Resume Matcher{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section">
    <div class="hero-content">
        <!-- JWT Authenticated Content (Hidden by default, shown by JS) -->
        <div id="jwt-authenticated-content" style="display: none;">
            <div id="jwt-has-resume-content" style="display: none;">
                <!-- Welcome Dashboard for JWT Users -->
                <div class="welcome-dashboard fade-in fade-in-on-scroll">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h1 class="hero-title">Welcome back, <span id="jwt-user-name" data-user-name>User</span>!</h1>
                            <p class="hero-subtitle">Your AI-powered career assistant is ready to accelerate your next career move</p>
                        </div>
                        <div class="col-md-4 text-end">
                            <div class="profile-stats">
                                <div class="stat-item">
                                    <span class="stat-number" id="match-count">0</span>
                                    <span class="stat-label">Job Matches</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-number" id="profile-score">0%</span>
                                    <span class="stat-label">Profile Score</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Dashboard -->
                <div class="dashboard-grid fade-in-on-scroll">
                    <div class="dashboard-card primary-card">
                        <div class="card-header">
                            <i class="fas fa-magic"></i>
                            <h3>AI Job Matching</h3>
                        </div>
                        <div class="card-content">
                            <p>Discover opportunities tailored to your unique skills and experience</p>
                            <a href="{% url 'ai_job_matches' %}?auto_search=true" class="btn btn-primary">
                                <i class="fas fa-rocket me-2"></i> Find Matches
                            </a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-user-edit"></i>
                            <h3>Profile Optimization</h3>
                        </div>
                        <div class="card-content">
                            <p>Enhance your profile to attract better opportunities</p>
                            <a href="{% url 'jwt_profile' %}" class="btn btn-outline-primary">
                                <i class="fas fa-cog me-2"></i> Optimize Profile
                            </a>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-file-alt"></i>
                            <h3>Resume Analysis</h3>
                        </div>
                        <div class="card-content">
                            <p>Get AI-powered insights to improve your resume</p>
                            <a href="{% url 'jwt_resume_upload' %}" class="btn btn-outline-primary">
                                <i class="fas fa-chart-line me-2"></i> Analyze Resume
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="jwt-no-resume-content" style="display: none;">
                <!-- Onboarding for JWT Users -->
                <div class="onboarding-container fade-in">
                    <h1 class="hero-title">Let's Build Your Career Profile</h1>
                    <p class="hero-subtitle">Upload your resume and unlock the power of AI-driven job matching</p>
                    
                    <div class="onboarding-card">
                        <div class="onboarding-steps">
                            <div class="step active">
                                <div class="step-icon">
                                    <i class="fas fa-upload"></i>
                                </div>
                                <h3>Upload Resume</h3>
                                <p>Share your professional experience with our AI</p>
                            </div>
                            <div class="step">
                                <div class="step-icon">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <h3>AI Analysis</h3>
                                <p>Our AI analyzes your skills and experience</p>
                            </div>
                            <div class="step">
                                <div class="step-icon">
                                    <i class="fas fa-target"></i>
                                </div>
                                <h3>Perfect Matches</h3>
                                <p>Get personalized job recommendations</p>
                            </div>
                        </div>
                        <div class="onboarding-action">
                            <a href="{% url 'jwt_resume_upload' %}" class="btn btn-primary btn-lg">
                                <i class="fas fa-file-upload me-2"></i> Upload Your Resume
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- JWT No-Auth Content (Default for non-authenticated users) -->
        <div id="jwt-no-auth-content">
            <div class="hero-main fade-in fade-in-on-scroll">
                <h1 class="hero-title gradient-text">Your AI-Powered Career Assistant</h1>
                <p class="hero-subtitle">Join thousands of professionals who found their dream jobs using our intelligent matching system across all industries</p>
                <div class="hero-actions">
                    <a href="{% url 'register' %}" class="btn btn-primary btn-lg pulse">
                        <i class="fas fa-rocket me-2"></i> Get Started Free
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-primary btn-lg">
                        <i class="fas fa-sign-in-alt me-2"></i> Sign In
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="features-section fade-in-on-scroll">
    <div class="container">
        <div class="section-header fade-in-on-scroll">
            <h2>Why Choose Smart Resume Matcher?</h2>
            <p>Advanced AI technology meets comprehensive career support</p>
        </div>
        
        <div class="features-grid fade-in-on-scroll">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-brain"></i>
                </div>
                <h3>AI-Powered Matching</h3>
                <p>Advanced machine learning algorithms analyze your skills, experience, and preferences to find the perfect job matches</p>
                <div class="feature-stats">
                    <span class="stat">95% Match Accuracy</span>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-globe-americas"></i>
                </div>
                <h3>All Industries Covered</h3>
                <p>From healthcare to technology, finance to education - find opportunities across every industry and profession</p>
                <div class="feature-stats">
                    <span class="stat">200+ Industries</span>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3>Career Analytics</h3>
                <p>Get detailed insights into your career progression, skill gaps, and market trends to make informed decisions</p>
                <div class="feature-stats">
                    <span class="stat">Real-time Insights</span>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h3>Privacy First</h3>
                <p>Your data is secure and private. We never share your information without your explicit consent</p>
                <div class="feature-stats">
                    <span class="stat">100% Secure</span>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h3>Real-time Updates</h3>
                <p>Get instant notifications about new job matches and industry trends that matter to your career</p>
                <div class="feature-stats">
                    <span class="stat">Instant Alerts</span>
                </div>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h3>Expert Support</h3>
                <p>Access career coaching, resume optimization tips, and interview preparation from industry experts</p>
                <div class="feature-stats">
                    <span class="stat">24/7 Support</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Stories Section -->
<div class="success-section" id="jwt-no-auth-content-extra">
    <div class="container">
        <div class="section-header">
            <h2>Success Stories</h2>
            <p>Real professionals, real results</p>
        </div>
        
        <div class="success-grid">
            <div class="success-card">
                <div class="success-content">
                    <p>"Smart Resume Matcher helped me transition from finance to tech. The AI found opportunities I never would have considered, and I landed my dream job as a data analyst!"</p>
                    <div class="success-author">
                        <strong>Sarah Chen</strong>
                        <span>Data Analyst at TechCorp</span>
                    </div>
                </div>
            </div>
            
            <div class="success-card">
                <div class="success-content">
                    <p>"The platform's career insights helped me identify skill gaps and improve my profile. Within 3 weeks, I had multiple interviews and accepted a senior position."</p>
                    <div class="success-author">
                        <strong>Michael Rodriguez</strong>
                        <span>Senior Marketing Manager</span>
                    </div>
                </div>
            </div>
            
            <div class="success-card">
                <div class="success-content">
                    <p>"As a healthcare professional, I was amazed by how accurately the AI matched my specialized skills with the right opportunities. Highly recommended!"</p>
                    <div class="success-author">
                        <strong>Dr. Emily Johnson</strong>
                        <span>Clinical Research Coordinator</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Job Matches Section for Authenticated Users -->
<div id="jwt-job-matches-section" style="display: none;">
    <div class="container">
        <div class="section-header">
            <h2>Your Latest Job Matches</h2>
            <p>Opportunities tailored specifically for you</p>
        </div>
        
        <div id="jwt-job-matches-container">
            <div class="loading-state">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Finding your perfect matches...</p>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="{% url 'ai_job_matches' %}" class="btn btn-outline-primary">
                <i class="fas fa-search me-2"></i> View All Matches
            </a>
        </div>
    </div>
</div>

<!-- AI Tips Section for Authenticated Users -->
<div id="jwt-tips-section" style="display: none;">
    <div class="container">
        <div class="tips-card">
            <div class="tips-header">
                <i class="fas fa-lightbulb"></i>
                <h3>AI Career Insights</h3>
            </div>
            <div class="tips-content">
                <p id="jwt-career-tip">{{ ai_tip|default:"Keep your resume updated and highlight your unique skills to attract better opportunities." }}</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize JWT authentication check for home page
    initializeHomePageAuth();
    
    // Add some interactive elements
    initializeInteractiveElements();
});

function initializeHomePageAuth() {
    // Wait for auth manager to be available
    const checkAuthManager = () => {
        if (typeof window.authManager !== 'undefined') {
            handleHomePageAuthentication();
        } else {
            setTimeout(checkAuthManager, 100);
        }
    };
    
    checkAuthManager();
}

function handleHomePageAuthentication() {
    const isAuthenticated = window.authManager.isAuthenticated();
    const userData = window.authManager.getUserData();
    
    console.log('Home page: Authentication status:', isAuthenticated);
    if (userData) {
        console.log('Home page: User data:', userData.email);
    }
    
    // CRITICAL FIX: Update navigation based on authentication status
    if (typeof window.authManager.updateNavigation === 'function') {
        console.log('Home page: Updating navigation...');
        window.authManager.updateNavigation();
    } else {
        console.warn('Home page: updateNavigation method not available');
    }
    
    // Show/hide content based on authentication status
    const jwtAuthContent = document.getElementById('jwt-authenticated-content');
    const jwtNoAuthContent = document.getElementById('jwt-no-auth-content');
    const jwtNoAuthContentExtra = document.getElementById('jwt-no-auth-content-extra');
    const jwtHasResumeContent = document.getElementById('jwt-has-resume-content');
    const jwtNoResumeContent = document.getElementById('jwt-no-resume-content');
    const jwtJobMatchesSection = document.getElementById('jwt-job-matches-section');
    const jwtTipsSection = document.getElementById('jwt-tips-section');
    
    if (isAuthenticated && userData) {
        console.log('User is authenticated via JWT:', userData);
        
        // Show authenticated content
        if (jwtAuthContent) jwtAuthContent.style.display = 'block';
        if (jwtNoAuthContent) jwtNoAuthContent.style.display = 'none';
        if (jwtNoAuthContentExtra) jwtNoAuthContentExtra.style.display = 'none';
        if (jwtJobMatchesSection) jwtJobMatchesSection.style.display = 'block';
        if (jwtTipsSection) jwtTipsSection.style.display = 'block';
        
        // Check if user has resume
        const hasResume = userData.latest_resume && userData.latest_resume.id;
        
        if (hasResume) {
            if (jwtHasResumeContent) jwtHasResumeContent.style.display = 'block';
            if (jwtNoResumeContent) jwtNoResumeContent.style.display = 'none';
            
            // Load job matches and stats
            loadJobMatches();
            loadUserStats(userData);
        } else {
            if (jwtHasResumeContent) jwtHasResumeContent.style.display = 'none';
            if (jwtNoResumeContent) jwtNoResumeContent.style.display = 'block';
            if (jwtJobMatchesSection) jwtJobMatchesSection.style.display = 'none';
        }
        
        // Update profile information
        updateProfileDisplay(userData);
    } else {
        console.log('User is not authenticated');
        
        // Show non-authenticated content
        if (jwtAuthContent) jwtAuthContent.style.display = 'none';
        if (jwtNoAuthContent) jwtNoAuthContent.style.display = 'block';
        if (jwtNoAuthContentExtra) jwtNoAuthContentExtra.style.display = 'block';
        if (jwtJobMatchesSection) jwtJobMatchesSection.style.display = 'none';
        if (jwtTipsSection) jwtTipsSection.style.display = 'none';
    }
}

function updateProfileDisplay(userData) {
    // Update any profile displays on the home page
    const userNameElements = document.querySelectorAll('[data-user-name]');
    userNameElements.forEach(element => {
        if (userData.profile && userData.profile.full_name) {
            element.textContent = userData.profile.full_name;
        } else if (userData.first_name && userData.last_name) {
            element.textContent = userData.first_name + ' ' + userData.last_name;
        } else {
            element.textContent = userData.username || 'User';
        }
    });
}

function loadUserStats(userData) {
    // Simulate loading user stats
    const matchCountElement = document.getElementById('match-count');
    const profileScoreElement = document.getElementById('profile-score');
    
    if (matchCountElement) {
        // You can implement actual API calls here
        animateNumber(matchCountElement, 0, 12, 1000);
    }
    
    if (profileScoreElement) {
        // Calculate a rough profile score based on available data
        let score = 20; // Base score
        if (userData.latest_resume) score += 40;
        if (userData.profile && userData.profile.full_name) score += 20;
        if (userData.email) score += 10;
        if (userData.profile && userData.profile.phone) score += 10;
        
        animateNumber(profileScoreElement, 0, score, 1500, '%');
    }
}

function animateNumber(element, start, end, duration, suffix = '') {
    const startTime = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function for smooth animation
        const easeOutQuart = 1 - Math.pow(1 - progress, 4);
        const current = Math.floor(start + (end - start) * easeOutQuart);
        
        element.textContent = current + suffix;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

async function loadJobMatches() {
    // Load job matches via API for authenticated users
    const jobMatchesContainer = document.getElementById('jwt-job-matches-container');
    if (!jobMatchesContainer) return;
    
    try {
        // Simulate API call - you can implement actual API call here
        setTimeout(() => {
            jobMatchesContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="job-card">
                            <h5>Senior Software Engineer</h5>
                            <p class="text-muted">TechCorp Inc.</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-success">95% Match</span>
                                <small class="text-muted">2 days ago</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="job-card">
                            <h5>Data Analyst</h5>
                            <p class="text-muted">DataFlow Solutions</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-primary">92% Match</span>
                                <small class="text-muted">1 week ago</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="job-card">
                            <h5>Product Manager</h5>
                            <p class="text-muted">Innovation Labs</p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="badge bg-info">89% Match</span>
                                <small class="text-muted">3 days ago</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }, 1500);
    } catch (error) {
        console.error('Error loading job matches:', error);
        jobMatchesContainer.innerHTML = `
            <div class="job-card text-center">
                <p class="text-danger">Failed to load job matches</p>
                <a href="/jobs/" class="btn btn-outline-primary">Browse Jobs</a>
            </div>
        `;
    }
}

function initializeInteractiveElements() {
    // Add smooth scrolling for internal links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    });
    
    // Add hover effects for feature cards
    const featureCards = document.querySelectorAll('.feature-card');
    featureCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-4px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });
    });
    
    // Add subtle animations to dashboard cards
    const dashboardCards = document.querySelectorAll('.dashboard-card');
    dashboardCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('fade-in');
    });
}

// Listen for authentication events
window.addEventListener('auth:login', function(event) {
    console.log('Home page: User logged in, updating content...');
    handleHomePageAuthentication();
});

window.addEventListener('auth:logout', function(event) {
    console.log('Home page: User logged out, updating content...');
    handleHomePageAuthentication();
});
</script>
{% endblock %}
